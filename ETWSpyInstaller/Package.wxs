<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Name="ETWSpy" Manufacturer="ETWSpy" Version="1.0.1" UpgradeCode="8B7E1A2C-3F4D-5E6A-9B0C-1D2E3F4A5B6C" InstallerVersion="500">
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Application icon for Add/Remove Programs -->
    <Icon Id="ETWSpy.ico" SourceFile="$(var.ETWSpyUI.ProjectDir)ETWSpy.ico" />
    <Property Id="ARPPRODUCTICON" Value="ETWSpy.ico" />

    <Feature Id="Main">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ProgramMenuShortcut" />
    </Feature>

    <!-- UI with welcome screen, install directory selection, and completion dialog -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />
    <ui:WixUI Id="WixUI_InstallDir" />

    <!-- Skip the license agreement dialog -->
    <UI>
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2" Condition="1" />
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2" Condition="1" />
    </UI>
  </Package>

  <Fragment>
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="ETWSpy" />
    </StandardDirectory>
  </Fragment>

  <Fragment>
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="ETWSpy" />
    </StandardDirectory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="ETWSpyUIExe">
        <File Id="ETWSpyUIExe" Source="$(var.ETWSpyUI.TargetDir)ETWSpyUI.exe" KeyPath="yes" />
      </Component>
      <Component Id="ETWSpyUIDll">
        <File Id="ETWSpyUIDll" Source="$(var.ETWSpyUI.TargetDir)ETWSpyUI.dll" KeyPath="yes" />
      </Component>
      <Component Id="ETWSpyLibDll">
        <File Id="ETWSpyLibDll" Source="$(var.ETWSpyUI.TargetDir)ETWSpyLib.dll" KeyPath="yes" />
      </Component>
      <Component Id="ETWSpyUIRuntimeConfig">
        <File Id="ETWSpyUIRuntimeConfig" Source="$(var.ETWSpyUI.TargetDir)ETWSpyUI.runtimeconfig.json" KeyPath="yes" />
      </Component>
      <Component Id="ETWSpyUIDepsJson">
        <File Id="ETWSpyUIDepsJson" Source="$(var.ETWSpyUI.TargetDir)ETWSpyUI.deps.json" KeyPath="yes" />
      </Component>
      <Component Id="IjwhostDll">
        <File Id="IjwhostDll" Source="$(var.ETWSpyUI.TargetDir)Ijwhost.dll" KeyPath="yes" />
      </Component>
      <Component Id="MicrosoftETWDll">
        <File Id="MicrosoftETWDll" Source="$(var.ETWSpyUI.TargetDir)Microsoft.O365.Security.Native.ETW.dll" KeyPath="yes" />
      </Component>
      <Component Id="ProviderNameGuidJson">
        <File Id="ProviderNameGuidJson" Source="$(var.ETWSpyUI.TargetDir)ProviderNameGuid.json" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <Component Id="ProgramMenuShortcut" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890" Directory="ApplicationProgramsFolder">
      <Shortcut Id="ApplicationStartMenuShortcut" 
                Name="ETWSpy" 
                Description="ETW Event Tracing Spy Tool" 
                Target="[INSTALLFOLDER]ETWSpyUI.exe" 
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\ETWSpy" Name="installed" Type="integer" Value="1" KeyPath="yes" />
    </Component>
  </Fragment>

</Wix>